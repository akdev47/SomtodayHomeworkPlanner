<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Somtoday Dashboard</title>

  <!--FONTS-->
  <link rel="stylesheet" href="style/edit-assignments-style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">

  <script src="javascript/assignmentPopup.js"></script>
</head>

<body class="josefin-sans-regular">
<div class="container">
  <div class="side-bar yellow">
    <div class="container-1">
      <img src="./res/WhatsApp_Image_2024-05-24_at_12.26.37-removebg-preview.png" alt="Somtoday logo"
           class="logo">
      <p class="logo-text">somtoday</p>
    </div>
    <div class="container-2">
      <ul class="navigations">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" />
              </svg>
            </i>
            <p class="nav-item-text">Home</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="assignments-teacher.html" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm80-80h280v-80H280v80Zm0-160h400v-80H280v80Zm0-160h400v-80H280v80Zm200-190q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-200v-560 560Z" />
              </svg>
            </i>
            <p class="nav-item-text">Assignments</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="notifications.html" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M160-200v-80h80v-280q0-83 50-147.5T420-792v-28q0-25 17.5-42.5T480-880q25 0 42.5 17.5T540-820v28q80 20 130 84.5T720-560v280h80v80H160Zm320-300Zm0 420q-33 0-56.5-23.5T400-160h160q0 33-23.5 56.5T480-80ZM320-280h320v-280q0-66-47-113t-113-47q-66 0-113 47t-47 113v280Z" />
              </svg>
            </i>
            <p class="nav-item-text">Notifications</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="classes.html" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M560-564v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-600q-38 0-73 9.5T560-564Zm0 220v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-380q-38 0-73 9t-67 27Zm0-110v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-490q-38 0-73 9.5T560-454ZM260-320q47 0 91.5 10.5T440-278v-394q-41-24-87-36t-93-12q-36 0-71.5 7T120-692v396q35-12 69.5-18t70.5-6Zm260 42q44-21 88.5-31.5T700-320q36 0 70.5 6t69.5 18v-396q-33-14-68.5-21t-71.5-7q-47 0-93 12t-87 36v394Zm-40 118q-48-38-104-59t-116-21q-42 0-82.5 11T100-198q-21 11-40.5-1T40-234v-482q0-11 5.5-21T62-752q46-24 96-36t102-12q58 0 113.5 15T480-740q51-30 106.5-45T700-800q52 0 102 12t96 36q11 5 16.5 15t5.5 21v482q0 23-19.5 35t-40.5 1q-37-20-77.5-31T700-240q-60 0-116 21t-104 59ZM280-494Z" />
              </svg>
            </i>
            <p class="nav-item-text">Classes</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="lessons.html" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M480-120 200-272v-240L40-600l440-240 440 240v320h-80v-276l-80 44v240L480-120Zm0-332 274-148-274-148-274 148 274 148Zm0 241 200-108v-151L480-360 280-470v151l200 108Zm0-241Zm0 90Zm0 0Z" />
              </svg>
            </i>
            <p class="nav-item-text">Lessons</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="profile.html" class="nav-link" id="profileLink">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                   width="24px">
                <path
                        d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z" />
              </svg>
            </i>
            <p class="nav-item-text">Profile</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="#help" class="nav-link">
            <i class="nav-item-icon">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
                <path
                        d="M478-240q21 0 35.5-14.5T528-290q0-21-14.5-35.5T478-340q-21 0-35.5 14.5T428-290q0 21 14.5 35.5T478-240Zm-36-154h74q0-33 7.5-52t42.5-52q26-26 41-49.5t15-56.5q0-56-41-86t-97-30q-57 0-92.5 30T342-618l66 26q5-18 22.5-39t53.5-21q32 0 48 17.5t16 38.5q0 20-12 37.5T506-526q-44 39-54 59t-10 73Zm38 314q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
              </svg>
            </i>
            <p class="nav-item-text">Help</p>
          </a>
        </li>
      </ul>
    </div>
    <div class="container-3">
      <div>
        <a href="#logout" class="nav-link">
          <i class="logout-icon">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
              <path
                      d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
            </svg>
          </i>
          <p>Logout</p>
        </a>
      </div>
    </div>
  </div>
  <main class="main-content">
    <header class="header">
      <h1 id="page-heading">Edit Assignment</h1> <!--FETCH REAL NAME HERE LATER-->
      <div class="user-settings">
        <input type="text" id="search-bar" placeholder="Search">
        <div id="search-results" class="search-results"></div>
        <div class="user-info">
          <span>Welcome, Student_Name!</span>
          <a href="user-profile.html"><img src="res/user-icon.png" alt="User Icon"></a>
        </div>
      </div>
    </header>
    <section class="content">
      <div class="homework-container">

        <div class="assignment-upload">
          <div>
            <h3>Assignment Name</h3>
            <input type="text" id="assignment-name">
            <span class="error-message" id="assignment-name-error"></span>
          </div>
          <div>
            <h3>Due Date</h3>
            <input type="date" id="due-date">
            <span class="error-message" id="due-date-error"></span>
          </div>
          <div>
            <h3>Choose Class</h3>
            <select name="class-selector" id="class-selector" disabled></select>
            <span class="error-message" id="class-selector-error"></span>
          </div>
          <div>
            <h3>Choose Lesson</h3>
            <select name="lesson-selector" id="lesson-selector" disabled></select>
            <span class="error-message" id="lesson-selector-error"></span>
          </div>
          <div class="time-split-container">
            <div>
              <h3>Time Indication</h3>
              <input type="number" id="time-indication">
              <span class="error-message" id="time-indication-error"></span>
            </div>
            <div class="checkbox-container">
              <h3>Is Homework Splittable</h3>
              <input type="checkbox" id="is-splittable">
            </div>
          </div>
        </div>
        <div class="assignment-goals">
          <h2>Assignment Goals</h2>
          <ul id="goals-list">
            <!-- Dynamically populated -->
          </ul>
          <div class="total-goals">
            <p id="total-goal-count">Total Goal Count: 0</p>
            <button class="add-goal-btn">Add Goal to this Assignment</button>
            <div class="pop-up-overlay goals-pop-up-overlay "></div>
            <form class="pop-up goals-pop-up" id="add-goal-form">
              <p>Enter goal's name</p>
              <input type="text" name="goal-name" id="goal-name">
              <input type="submit" value="Create Goal" class="submit-btn">
            </form>
          </div>
        </div>
      </div>
      <div class="assignment-description">

        <h2>Assignment Description</h2>
        <textarea class="description-input" id="assignment-description"></textarea>
        <span class="error-message" id="assignment-description-error"></span>
        <div class="btn-container">
          <p id="last-saved">Last saved: Never</p>
          <button class="save-btn" id="save-btn">Save</button>
        </div>
      </div>

      <button class="publish-assignment-btn" id="publish-btn">Publish Assignment</button>
    </section>
  </main>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const homeworkId = new URLSearchParams(window.location.search).get('homeworkId');
    const role = sessionStorage.getItem('role');
    const personId = sessionStorage.getItem('personId');

    const classSelector = document.getElementById("class-selector");
    const lessonSelector = document.getElementById("lesson-selector");
    const assignmentNameInput = document.getElementById('assignment-name');
    const dueDateInput = document.getElementById('due-date');
    const timeIndicationInput = document.getElementById('time-indication');
    const descriptionInput = document.getElementById('assignment-description');
    const goalsList = document.getElementById('goals-list');
    const homeworkSplittableInput = document.getElementById('is-splittable');
    const totalGoalCount = document.getElementById('total-goal-count');

    if (personId) {
      profileLink.href = `profile.html?personId=${personId}`;
    }

    let savedData = {
      homeworkId: homeworkId,
      homeworkName: '',
      dueDate: null,
      publishDate: null,
      classId: 0,
      lessonId: 0,
      description: '',
      goals: [],
      timeIndication: null,
      homeworkSplittable: false
    };

    function fetchClasses() {
      console.log('Fetching classes...');
      fetch(`api/fetchClasses?role=${role}&personId=${personId}`)
              .then(response => response.json())
              .then(classes => {
                classes.forEach(ownClass => {
                  const option = document.createElement('option');
                  option.value = ownClass.class_id;
                  option.textContent = ownClass.class_name;
                  classSelector.appendChild(option);
                });
              })
              .catch(error => console.error('Error fetching classes:', error));
    }

    function convertTimeToMinutes(timeStr) {
      const [hours, minutes, seconds] = timeStr.split(':').map(Number);
      const totalMinutes = hours * 60 + minutes;
      return totalMinutes;
    }

    function fetchLessons(classId) {
      console.log('Fetching lessons...');
      fetch(`api/fetchLessons?classId=${classId}`)
              .then(response => response.json())
              .then(lessons => {
                lessons.forEach(lesson => {
                  const option = document.createElement('option');
                  option.value = lesson.lesson_id;
                  option.textContent = lesson.lesson_name;
                  lessonSelector.appendChild(option);
                });
              })
              .catch(error => console.error('Error fetching lessons:', error));
    }

    function fetchAssignmentDetails() {
      console.log('Fetching assignment details...');
      fetch(`api/editAssignment?homeworkId=${homeworkId}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                assignmentNameInput.value = data.homeworkName;
                dueDateInput.value = data.dueDate;
                timeIndicationInput.value = convertTimeToMinutes(data.timeIndication);
                descriptionInput.value = data.description;
                classSelector.value = data.classId;
                fetchLessons(data.classId);
                lessonSelector.value = data.lessonId;
                homeworkSplittableInput.checked = data.homeworkSplittable;

                goalsList.innerHTML = '';
                data.goals.forEach(goal => {
                  const goalItem = document.createElement('li');
                  goalItem.innerHTML =
                          `<span class="goal-name">${goal.name}</span>
                             <button type="button" class="remove-goal-btn">x</button>`;
                  goalItem.querySelector('.remove-goal-btn').addEventListener('click', function() {
                    goalItem.remove();
                    updateTotalGoals();
                  });
                  goalsList.appendChild(goalItem);
                });
                updateTotalGoals();
              })
              .catch(error => console.error('Error fetching assignment details:', error));
    }

    function updateTotalGoals() {
      const goals = goalsList.querySelectorAll('li');
      totalGoalCount.textContent = `Total Goal Count: ${goals.length}`;
    }

    function validateForm() {
      let isValid = true;

      // Clear previous error messages
      document.getElementById('assignment-name-error').textContent = '';
      document.getElementById('due-date-error').textContent = '';
      document.getElementById('class-selector-error').textContent = '';
      document.getElementById('lesson-selector-error').textContent = '';
      document.getElementById('time-indication-error').textContent = '';
      document.getElementById('assignment-description-error').textContent = '';

      if (!assignmentNameInput.value) {
        isValid = false;
        document.getElementById('assignment-name-error').textContent = 'Assignment name is required.';
      }
      if (!dueDateInput.value) {
        isValid = false;
        document.getElementById('due-date-error').textContent = 'Due date is required.';
      }
      if (!classSelector.value) {
        isValid = false;
        document.getElementById('class-selector-error').textContent = 'Class selection is required.';
      }
      if (!lessonSelector.value) {
        isValid = false;
        document.getElementById('lesson-selector-error').textContent = 'Lesson selection is required.';
      }
      if (!timeIndicationInput.value) {
        isValid = false;
        document.getElementById('time-indication-error').textContent = 'Time indication is required.';
      }
      if (!descriptionInput.value) {
        isValid = false;
        document.getElementById('assignment-description-error').textContent = 'Assignment description is required.';
      }

      return isValid;
    }

    document.getElementById('save-btn').addEventListener('click', function() {
      if (!validateForm()) return;

      savedData.homeworkName = assignmentNameInput.value;
      savedData.dueDate = dueDateInput.value;
      savedData.classId = classSelector.value;
      savedData.lessonId = lessonSelector.value;
      savedData.description = descriptionInput.value;
      savedData.timeIndication = timeIndicationInput.value;
      savedData.homeworkSplittable = homeworkSplittableInput.checked;
      savedData.goals = [];
      goalsList.querySelectorAll('li').forEach(goalItem => {
        const goalName = goalItem.querySelector('.goal-name').textContent;
        savedData.goals.push({ name: goalName });
      });

      localStorage.setItem('assignmentData', JSON.stringify(savedData));
      document.getElementById('last-saved').textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
    });

    document.getElementById('publish-btn').addEventListener('click', function() {
      if (!validateForm()) return;

      savedData.publishDate = new Date().toISOString().split('T')[0];

      fetch('/api/editAssignment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(savedData)
      })
              .then(response => {
                if (response.ok) {
                  console.log('Assignment updated successfully');
                  window.location.href = 'assignments-teacher.html';
                } else {
                  return response.json().then(err => { throw new Error(err.message); });
                }
              })
              .catch(error => console.error('Error updating assignment:', error));
    });

    const goalForm = document.getElementById('add-goal-form');
    const goalNameInput = document.getElementById('goal-name');

    goalForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const goalName = goalNameInput.value;

      if (goalName) {
        const goalItem = document.createElement('li');
        goalItem.innerHTML =
                `<span class="goal-name">${goalName}</span>
                     <button type="button" class="remove-goal-btn">x</button>`;

        goalItem.querySelector('.remove-goal-btn').addEventListener('click', function() {
          goalItem.remove();
          updateTotalGoals();
        });

        goalsList.appendChild(goalItem);
        updateTotalGoals();

        // Reset form inputs
        goalNameInput.value = '';
      }
    });

    fetchClasses();
    fetchAssignmentDetails();
  });
</script>





</body>

</html>
